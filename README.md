# epithelial_spheroids
Semi-automated analysis of epithelial spheroid polarity in 3D culture
To perform spheroid classification, the analysis tool examines a number of descriptive shape parameters and the distributions of different fluorescent marker signals in the equatorial plane of epithelial cell spheroids. The ImageJ / FIJI macro spheroids.ijm processes original images and determines shape parameters, feeding the MATLAB scripts OpenFolder.m and readstack.m with all information needed for further analysis. To allow adaption of the tool to variable assay conditions and / or markers, a classification tree is trained using the "Classification Learner App" and a subset of manually classified spheroids. The bulk of spheroids is analysed by the script Classification.m in an automated fashion based on the results file of OpenFolder.m, which contains a set of 15 parameters for each spheroid, and the trained classification tree.
Example image files and exemplary set of decision trees are available at: https://owncloud-shib.gwdg.de/index.php/s/atBSGxKSFTemHuN
ImageJ / FIJI macros were developed using the ImageJ version 2.0.0-rc-59/1.51k packaged in the FIJI distribution. MATLAB (The MathWorks, Inc.; Natick, MA, United States) scripts were implemented in version R2015b (Version 8.6- 3 Sep 2015). ImageJ macros were written to process Zeiss Vision Image ".zvi" or Tagged Image File ".tif" formats with a resolution of 0.1625 µm per pixel (typical size, 256 x 256 pixels for each plane and color). A different scale of the images may require adaptation of pixel values in spheroids.ijm. Usage of the bio-formats FIJI plugin allows adaption to other image formats. For training of the decision tree and usage of trained classifiers in MATLAB analysis with Classification Learner App, the "Statistics and Machine Learning Toolbox" is required. Furthermore, in MATLAB the cell2string function is needed to extract the image names from the files list.
Detailed Workflow:
1.  spheroids.ijm
The ImageJ macro is written to process the spheroid image files. Images should consist of 4-colour fluorescence stacks, representing the whole spheroid. Channel order (1) basolateral marker, (2) apical marker, (3) actin network, (4) nuclei. For changing the order of channels uncomment "run("Arrange Channels...", "new=1324");" to spheroids.ijm line 123 and replace "1324" by your order of channels according to pre-defined channel positions. The functions of the macro are to copy and save the equatorial plane of each spheroid as a maximum intensity projection by assuming z/2 +/-3 slices (6x 2.24µm = 1.5µm thickness). The next step is to copy the nuclei channel, sum all z_slices, create a binary mask and determines CenterofMass of the spheroid. The maximum radius of each spheroid is calculated via a projection of all 4 channels, followed by creation of a binary mask and calculation of the distance from the outline to the center of mass. A possible lumen is detected by thresholding the actin signal and take the most intense 6% to produce a binary mask. All positions and distances are saved in a results file of “*.csv” format.
2. Open folder.m and readstack.m
The MATLAB script is used to open the folder of equatorial plane projections (4-channel stacks) and the Results.csv file. Calling the third script “readstack.m”, this input is used to plot the relative fluorescence signals against the max. radius to extract order of the marker signals and initial slope of the nuclei. The distance (i) between apical and basolateral signal and (ii) apical signal to actin are calculated. Result is a set of 15 parameters describing shape and signal distributions in the spheroids. Results of all spheroids are saved for further processing in a text file <ResultsTable of Parameters.csv> and also in the MATLAB file <Results.mat>. Furthermore, normalized cumulative radial intensity distribution values for each channel are saved as single tab-delimited CSV files in addition to their plots in PDF format.
3. Classification.m
The last macro can be used to apply a trained (set) of classification trees or other classifiers to the results file of step 2. Numeric parameters are used to classify the spheroid images. By manual selection within the user dialog, the classifier <Spheroids_complex_tree_compact.mat> and the results file <Results.mat> from previous scripts are loaded and spheroid classified. After initial classification, the relative amount of spheroids with potentially wrong group assignment is estimated based on parameter profiles, and the user is asked, if a re-classification step should be executed. Selection of "Cancel" skips the re-classification, results are saved and the script terminates. If "Continue" is selected, the script requires an additional set of trained decision trees as input, performs re-classification, and saves spheroid parameters and classification results (indicating also whether or not re-grouping was required). Results are stored within one table <EndResults.csv> that can be imported for further analysis in any spreadsheet software.
Example image files and exemplary set of decision trees are available at: https://owncloud-shib.gwdg.de/index.php/s/atBSGxKSFTemHuN

Troubleshooting:
Potential sources of error and explanatory comments on the usage of macros and scripts.

Batch mode: To conceal opening and processing of images, uncomment the command “setBatchMode(true);” in spheroids.ijm line 106.

Image scale and pixel value adaption in spheroids.ijm: A different scale of the images and usage of other biological or technical equipment may require adaptation of pixel values to select ROIs for spheroids, actin and nuclei (spheroids.ijm, lines 260, 357, 385, 529).

In case of another staining order: Macros are written for the staining order (1) basolateral marker, (2) apical marker, (3) actin network, (4) nuclei. For changing the order of channels uncomment "run("Arrange Channels...", "new=1324");" to spheroids.ijm line 123 and replace "1324" by your order of channels according to pre-defined channel positions.

Contrast enhancement in spheroids.ijm on equatorial plane image: Exported images of equatorial planes are subjected for contrast enhancement with an intensity saturation of 0.35 % not using normalisation (spheroids.ijm, line 424). Without normalisation, intensity values are not altered. This step was added for a better display of 16-bit images. For 8-bit images, this step is not relevant and should be eliminated (spheroids.ijm, lines 422-425).

Intensity threshold for actin signal in spheroids.ijm: The intensity threshold for the F-actin staining was set to 94 % in an 8-bit converted image of the average intensity projection (spheroids.ijm, line 47). This value was determined testing different proportions and comparing the resulting binary mask with the signal for its usefulness. Different cell types and experimental procedures may require different values and thus demand adaptation. 

cell2string [28] function should be placed within the MATLAB directory or added to the path, in which MATLAB is working. 

MATLAB script OpenFolder.m: "cell_r" – Index exceeds matrix dimensions. The cell delivered by readstack.m is too small. Deactivate lines 24 and 425 by conversion to a comment, uncomment lines 21-23 and fill in correct file names. Then test if the readstack.m script creates the correct size of cell [1 16]. If so, restart MATLAB and retry using original scripts. 

Classification.m: The number of classified spheroids is smaller than the number of original images. The script OpenFolder.m saves a results cell, wherein the last 2 rows are empty, [numel(files)+1, 1 file more than spheroid images]. If additional rows are missing/removed manually, change Classification.m line 47 to "res_red=zeros(m-1,n-1)".

Cutoff values for determination of potentially wrong group assignment, Classification.m: Cutoff values are optimized for the exemplary data set, other data sets may require adaptation.

Reclassification does not work on the correct spheroids. Please make sure, that the response classes of <Spheroids_complex_tree_compact.mat> and values used in Classification.m lines 175, 189 and 199 are the same.
